SPLUNK FORWARDER
	Splunk Forwarder is a lightweight agent installed on the endpoint intended to be monitored, and its main task is to collect the data and send it to the Splunk instance. 

SPLUNK INDEXER
	Splunk Indexer plays the main role in processing the data it receives from forwarders. It takes the data, normalizes it into field-value pairs, determines the datatype of the data, and stores them as events. 


SEARCH HEAD
	Splunk Search Head is the place within the Search & Reporting App where users can search the indexed logs as shown below. 


source="VPNlogs.json" host="ip-10-10-40-195" sourcetype="_json" Source_ip="107.3.206.58"

TIME:
	earliest=<%m/%d/%Y:%H:&M:%S> latest <%m/%d/%Y:%H:&M:%S>
	
BASIC SEARCHING:
	index
	host
	source
	
	Keywords
		failed, error
		
	Phrases
		"failed login"
		
	Fields - key value pairs
		user=user1.comain.comain
	
	Wildcards:
		*fail*
		
	Booleans:
		AND, OR, NOT
		
	Tabular output for charting:
		chart / timechart
		
	Renames a specific field
		rename
		
	Sorts results by specific fields
		sort
		
	Statistics
		stats
		
	Calculates an expresion
		eval
		
	Removes duplicates
		dedup
		
	Builds a table with specified fields
		Table
	
	Returns the most common values of a given value
		top <field>
	
	Returns the least common values of a given value
		rare <field>
	
	Stats
		stats <function(field)> by <field(s)>
		stats count(failed_logins) by user
		
	Examples:
		host=myhost.lcl source=hstlogs user=* (message=fail* OR message=lock*)
		| table _time user message
		| sort -_time
		
		host=splunkmain | eval new_time=strftime(_time, "%m-%d-%y %I:%M%p") | table _time new_time
		
	Windows binaries being used to execute malicious code:
		index= botsv1 source="WinEventLog:Microsoft-Windows-Sysmon/Operational" 
		Image"*\\powershell.exe" OR Image"*\\msbuild.exe" OR Image"*\\psexec.exe" OR Image"*\\at.exe" OR Image"*\\schtasks.exe" OR Image"*\\net.exe" OR Image"*\\vssadmin.exe" OR Image"*\\utilman.exe" OR Image"*\\wmic.exe" OR Image"*\\mshta.exe" OR Image"*\\wscript.exe" OR Image"*\\cscript.exe" OR Image"*\\cmd.exe" OR Image"*\\whoami.exe" OR Image"*\\mmc.exe" OR Image"*\\systeminfo.exe" OR Image"*\\csvde.exe" OR Image"*\\certutil.exe" | stats values(CommandLine) by Image

	Remote priv user enumeration through net.exe
		index=your_index sourcetype="xmlwineventlog:microsoft-windowssysmon/operational" process="*\\net.exe" (CommandLine="*net group*" OR  CommandLine="*net localgroup*") | stats count by Computer,CommandLine

	Powershell executing an encoded script
		index=your_index sourcetype="xmlwineventlog:microsoft-windowssysmon/operational" process="*\\powershell.exe" (CommandLine="*-encodedcommand*" OR CommandLine="*-enc*" OR CommandLine="*-e*" OR CommandLine="*-ec*" OR CommandLine="*-encodedcomman*" OR CommandLine="*-encodedcomma*" OR CommandLine="*-encodedcomm*" OR CommandLine="*-encodedcom*" OR CommandLine="*-encodedco*" OR CommandLine="*-encodedc*" OR CommandLine="*-encoded*" OR CommandLine="*-encoded*" OR CommandLine="*-encode*" OR CommandLine="*-encod*" OR CommandLine="*-enco*" OR CommandLine="*-en*" OR ) | stats count by CommandLine | top CommandLine

	Mimikatz
		index=your_index sourcetype="xmlwineventlog:microsoft-windowssysmon/operational" (CommandLine="*privileges::debug*" OR CommandLine="*sekurlsa::*" OR CommandLine="*kerberos::*" OR CommandLine="*crypto::*" OR CommandLine="*lsadump::*" OR CommandLine="*process::*")

	PSExec
		index=your_index sourcetype="xmlwineventlog:microsoft-windowssysmon/operational" Hashes="*IMPHASH=B18A1401FF8F444056D29450FBC0A6CE*" NOT process="*PsExec.exe"

	rundll32 being executed on an endpoint, and covers the case of Office binaries calling rundll32:
		index=your_index sourcetype="xmlwineventlog:microsoft-windowssysmon/operational" EventCode=1 rundll32.exe | search Image="*\\rundll32.exe" (CommandLine"*\\AppData\\Local\\Temp*" CommandLine="*qwerty*") OR (ParentImage="*\\winword.exe" OR ParentImage="*\\excel.exe" OR ParentImage="*\\cscript.exe" OR ParentImage="*\\wscript.exe" OR ParentImage="*\\mshta.exe")

	Malware beaconinig
		index=botsv1 source="stream:dns" message_type="QUERY" | fields _time, query | streamstats current=f last(_time) as last_time by query | eval gap=last_time - _time | stats count avg(gap) AS VarianceBeaconTime BY query | eval AverageBeaconTime=round(VarianceBeaconTime,3) | sort -count | where VarianceBeaconTime < 60 AND count > 2 AND AverageBeaconTime > 1.000 | table query VarianceBeaconTime count AverageBeaconTime

	Malicious Powershell activity
		index=botsvi EventID=4688 (BaseFileName=powershell.exe OR BaseFileName=powershell_ise.exe OR BaseFileName=cmd.exe) (Copy-Item OR .CopyHere OR New-Object OR WebClient OR DownloadFile OR downloadstring OR WebRequest OR restmethod) (CommandLine="Copy-Item*" OR CommandLine="CopyHere*" OR CommandLine="New-Object*" OR CommandLine="WebClient*" OR CommandLine="DownloadFile*" OR CommandLine="downloadstring*" OR CommandLine="WebRequest*" OR CommandLine="restmethod*" OR CommandLine="iex*" OR CommandLine="comobject*InternetExplorer*" OR CommandLine="Msxml2.XMLHTTP*" OR CommandLine="WinHttp*" OR CommandLine="bitstransfer*" I table time, Computer, SubjectDomainName, SubjectUserName, BaseFileName, CommandLine, CreatorProcessName, NewProcessName, FileDescription, FileVersion, MD5 

	Unauthorized DNS servers
		index=your_index sourcetype=stream:dns dest_port=53 dest_ip!=10.0.0.0/8 | stats dc(src_ip) values(src_ip) by dest_ip

	SQL INjection attempts:
		index=botsvl sourcetype="iis" | regex cs_uri_query="(?i) (?:-- |\;|\A*|\@|\@|\@version|char|alter|begin|cast|create|cursor|declare|delete|drop|end|exec|fetch|insert|kill|open|selec t|sys|table|update)" | stats count by host c_ip_cs_uri_stem_cs_uri_query | rex field=cs_uri_query"(?i) (?<suspect>-- |\;|\A*|\@|\@|\@version|char|alter|begin|cast|create|cursor|declare|delete|drop|end|exec|fetch|insert|kill|open|selec t|sys|table|update)" max match=0 

	WMI based persistence:
		index=* source="WinEventLog:Microsoft-Windows-WMI-Activity/Operational" (EventCode=5858 OR EventCode=5859 OR EventCode=19 OR EventCode=20 OR EventCode=21) | 
		search (TargetInstance='Win32_ProcessStartup' OR TargetInstance='__EventFilter') AND (NewEventName="*persistence*" OR TargetInstanceName="*persistence*")

	UAC Bypass:
		| tstats `security_content_summariesonly` count min(_time) AS firstTime max(_time) AS lastTime FROM datamodel=Endpoint.Processes BY _time span=1h Processes.user Processes.process_id Processes.process_name Processes.process Processes.process_path Processes.dest Processes.parent_process_name Processes.parent_process Processes.process_guid 
		| `drop_dm_object_name(Processes)` 
		| join process_guid [ 
		| tstats `security_content_summariesonly` count FROM datamodel=Endpoint.Registry WHERE (Registry.registry_path="*mscfile\\shell\\open\\command\\*") BY _time span=1h Registry.registry_path Registry.registry_key_name Registry.registry_value_name Registry.registry_value_data Registry.process_guid 
		| `drop_dm_object_name(Registry)`] 
		| fields firstTime lastTime dest user parent_process_name parent_process process_name process_path process registry_key_name registry_path registry_value_name registry_value_data process_guid 
		| where isnotnull(registry_value_data) 
		| `security_content_ctime(firstTime)` 
		| `security_content_ctime(lastTime)` 
		| `eventvwr_uac_bypass_filter`

	net.exe accessing administrative shares
		sourcetype=WinEventLog:Security (EventCode=4624 OR EventCode=4672) Logon_Type=3 NOT user="*$" NOT user="ANONYMOUS LOGON" 
		| stats  count BY dest src_ip dest_nt_domain user EventCode 
		| sort count

	Lateral Movement
		index=wineventlog sourcetype=WinEventLog:Security (EventCode=4624 OR EventCode=4672) Logon_Type=3 NOT user="*$" NOT user="ANONYMOUS LOGON" 
		| stats  count  BY dest src_ip dest_nt_domain user EventCode 
		| sort count


		
